<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PM2.5 DATA</title>
    <style>

html, body, #map {
  width: 100%;
  height:  100%;
  margin: 0;
  padding: 0;
}
body {
    font: 12px Arial;
}
path {
    stroke: steelblue;
    stroke-width: 2;
    fill: none;
}
.axis path, .axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;
}



</style>
</head>
<body>

  StartDate:
  <input id="StartDate" type="text" name="firstname" value="2016-01-01 00:00:00">
  EndDate:
  <input id="EndDate" type="text" name="lastname" value="2016-01-02 00:00:00">
  <button onclick="selectdate()">submit</button>


<div id="map"></div>

</body>
<script
  src="https://code.jquery.com/jquery-3.2.1.js"
  integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE="
  crossorigin="anonymous"></script>
<script src="//d3js.org/d3.v3.min.js"></script>
<script>
// Create the Google Map…
var map;
var marker;
var StartDate;
var EndDate;
function initMap(){
map = new google.maps.Map(d3.select("#map").node(), {
  zoom: 8,
  center: new google.maps.LatLng(23.725822, 120.772193),
  mapTypeId: google.maps.MapTypeId.TERRAIN
});

//getjson
getjson();

//post code
//selectdate();

};


// $(function(){
//   $("button").click(function(){
//         //var dateTime = $("#DateTime").val();
//         //var station = $("#Station").val();
//         //console.log(dateTime,station); 
//             $.ajax({
//       url:"{% url "postpractice" %}",
//       type:"POST",
//       data:{
//         "station":"古亭",
//         "startTime":"2016-05-26",
//       },
//     success:function(data){
//         console.log(data);
//     }
//     });
//   });
// });

function selectdate(){

    //console.log(dateTime ,station);
    $(function(){
      $("button").click(function(){
         StartDate = $("#StartDate").val();
         EndDate = $("#EndDate").val();
        console.log(StartDate,EndDate);
//   $.ajax({
//       url:"{% url "postpractice" %}",
//       type:"POST",
//       data:{
//         "station":"古亭",
//         "startTime":"2016-05-26",
//       },
//     success:function(data){
//         //console.log(data);
//             }
// });
      });
    });
    };


function getjson(){
    d3.json("{% url "locationApi" %}", function( error,data) {
        var jsonData = JSON.parse(data);
        //console.log(jsonData)
        for (i=0; i<Object.keys(jsonData).length; i++){
            //console.log(jsonData[i]["SiteName"])
            marker = new google.maps.Marker({
                position: new google.maps.LatLng(jsonData[i]["TWD97Lat"],jsonData[i]["TWD97Lon"]),
                title:jsonData[i]["SiteName"],
            });

            google.maps.event.addListener(marker,"click",(function(marker,i){
                return function(){
                console.log(jsonData[i]["SiteName"])
                //bad api url
                var url = "{% url "gasInfo" %}";
              $.ajax({
              url:url ,
              type:"POST",
              data:{
              "station":jsonData[i]["SiteName"],
              //"startTime":"2016-05-26",
              },
            success:function(rangeofData){
                var gasData = JSON.parse(rangeofData);
                var d3inputData = Object.values(gasData);
                dateObj(d3inputData);
                var d3Data = d3inputData.filter(function(el){
                              return el.DT >= new Date(StartDate) && el.DT <= new Date(EndDate)
                        });
                
                console.log(d3Data);
                d3fig(d3Data);
            }
            });       
                }
            })(marker,i));
            marker.setMap(map);
        };
    });
};

function dateObj(dateArray){
      for (i= 0; i<dateArray.length;i++){
          dateArray[i]["DT"] = new Date(dateArray[i]["DT"])
      };
      return dateArray
};

function d3fig(data){
  var margin = {
    top: 30,
    right: 20,
    bottom: 30,
    left: 50
};
var width = 1500 - margin.left - margin.right;
var height = 270 - margin.top - margin.bottom;

var x = d3.time.scale().range([0, width]);
var y = d3.scale.linear().range([height, 0]);

var xAxis = d3.svg.axis().scale(x)
    .orient("button").ticks(data.length);

var yAxis = d3.svg.axis().scale(y)
    .orient("left").ticks(5);

var valueline = d3.svg.line()
    .x(function (d) {
      return x(d.DT);
    })
    .y(function (d) {
      return y(d.PM2dot5);
    });

var svg = d3.select("body")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

x.domain(d3.extent(data, function (d) {
    return d.DT;
    }));
y.domain([0, d3.max(data, function (d) {
    return d.PM2dot5;
    })]);

svg.append("path") // Add the valueline path.
.attr("d", valueline(data));

svg.append("g") // Add the X Axis
.attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis);

svg.append("g") // Add the Y Axis
.attr("class", "y axis")
    .call(yAxis);

}





</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDiL1ij0sg-YB_C4mQvYWK8ze7MGgtEhbo&callback=initMap"   type="text/javascript"></script>

</html>